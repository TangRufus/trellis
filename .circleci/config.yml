version: 2.1

orbs:
  trellis:
    executors:
      python-27:
        docker:
          - image: 'circleci/python:2.7'
      python-36:
        docker:
          - image: 'circleci/python:3.6'

    jobs:
      syntax-check:
        parameters:
          ansible-version:
            type: string
          python-version:
            type: enum
            enum: ['36', '27']
        executor: python-<< parameters.python-version >>
        steps:
          - run: python --version
          - checkout
          - restore_cache:
              keys:
                - ansible-v1-<< parameters.python-version >>-<< parameters.ansible-version >>-{{ checksum "requirements.yml" }}
          - run:
              name: Install Python dependencies in a venv
              command: |
                virtualenv venv
                . venv/bin/activate
                pip install ansible<< parameters.ansible-version >>
                ansible --version
          - run:
              name: Install Galaxy roles
              command: |
                . venv/bin/activate
                ansible-galaxy install -r requirements.yml
          - save_cache:
              key: ansible-v1-<< parameters.python-version >>-<< parameters.ansible-version >>-{{ checksum "requirements.yml" }}
              paths:
                - venv
                - vendor
          - run:
              name: Check Playbook syntax
              command: |
                . venv/bin/activate
                ansible-playbook --syntax-check -e env=development deploy.yml
                ansible-playbook --syntax-check -e env=development dev.yml
                ansible-playbook --syntax-check -e env=development server.yml

      provision:
        parameters:
          ansible-version:
            type: string
          python-version:
            type: enum
            enum: ['36', '27']
        executor: python-<< parameters.python-version >>
        steps:
          - run: python --version
          - checkout
          - restore_cache:
              keys:
                - ansible-v1-<< parameters.python-version >>-<< parameters.ansible-version >>-{{ checksum "requirements.yml" }}
          - run: sudo pip install ansible<< parameters.ansible-version >>
          - run: ansible --version
          - run: ansible-galaxy install -r requirements.yml
          - save_cache:
              key: ansible-v1-<< parameters.python-version >>-<< parameters.ansible-version >>-{{ checksum "requirements.yml" }}
              paths:
                - vendor
          - run: sudo ansible-playbook server.yml -e env=production --connection=local

workflows:
  # syntax-check:
  #   jobs:
  #     - trellis/syntax-check:
  #         name: syntax-check-python-36-ansible-latest
  #         python-version: '36'
  #         ansible-version: ''
  #     - trellis/syntax-check:
  #         name: syntax-check-python-36-ansible-2.8
  #         python-version: '36'
  #         ansible-version: ~=2.8.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-36-ansible-2.7
  #         python-version: '36'
  #         ansible-version: ~=2.7.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-36-ansible-2.6
  #         python-version: '36'
  #         ansible-version: ~=2.6.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-36-ansible-2.5
  #         python-version: '36'
  #         ansible-version: ~=2.5.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-36-ansible-2.4
  #         python-version: '36'
  #         ansible-version: ~=2.4.0

  #     - trellis/syntax-check:
  #         name: syntax-check-python-27-ansible-latest
  #         python-version: '27'
  #         ansible-version: ''
  #     - trellis/syntax-check:
  #         name: syntax-check-python-27-ansible-2.8
  #         python-version: '27'
  #         ansible-version: ~=2.8.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-27-ansible-2.7
  #         python-version: '27'
  #         ansible-version: ~=2.7.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-27-ansible-2.6
  #         python-version: '27'
  #         ansible-version: ~=2.6.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-27-ansible-2.5
  #         python-version: '27'
  #         ansible-version: ~=2.5.0
  #     - trellis/syntax-check:
  #         name: syntax-check-python-27-ansible-2.4
  #         python-version: '27'
  #         ansible-version: ~=2.4.0

  provision:
    jobs:
      - trellis/provision:
          name: provision-python-36-ansible-2.7
          python-version: '36'
          ansible-version: ~=2.7.0
      - trellis/provision:
          name: provision-python-27-ansible-2.7
          python-version: '27'
          ansible-version: ~=2.7.0
